{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/lib/database.ts"],"sourcesContent":["// Neon database connection\r\nimport { neon } from '@neondatabase/serverless';\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  throw new Error('DATABASE_URL environment variable is not set');\r\n}\r\n\r\nconst sql = neon(process.env.DATABASE_URL!);\r\n\r\nexport { sql };\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;AAC3B;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,IAAA,2KAAI,EAAC,QAAQ,GAAG,CAAC,YAAY"}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/lib/security/password-hash.ts"],"sourcesContent":["import * as bcrypt from 'bcryptjs';\r\n\r\nconst SALT_ROUNDS = 12; // Industry standard for bcrypt\r\n\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  if (!password || password.length < 8) {\r\n    throw new Error('Password must be at least 8 characters long');\r\n  }\r\n  \r\n  try {\r\n    const hash = await bcrypt.hash(password, SALT_ROUNDS);\r\n    return hash;\r\n  } catch (error) {\r\n    console.error('[Password Hash Error]', error);\r\n    throw new Error('Failed to hash password');\r\n  }\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\r\n  try {\r\n    if (!password || !hash) {\r\n      return false;\r\n    }\r\n    const isMatch = await bcrypt.compare(password, hash);\r\n    return isMatch;\r\n  } catch (error) {\r\n    console.error('[Password Verify Error]', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Generate hash for setup purposes\r\nexport async function generateHashForSetup(password: string): Promise<string> {\r\n  return await hashPassword(password);\r\n}\r\n\r\nexport function createPasswordHash(password: string): { hash: string; salt: string } {\r\n  // For bcryptjs, the salt is embedded in the hash, but we return a compatible format\r\n  // This is a synchronous version for setup scripts\r\n  const crypto = require('crypto');\r\n  const salt = crypto.randomBytes(32).toString('hex');\r\n  const hash = crypto.pbkdf2Sync(password, salt, 100000, 32, 'sha256').toString('hex');\r\n  return { hash, salt };\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,cAAc,IAAI,+BAA+B;AAEhD,eAAe,aAAa,QAAgB;IACjD,IAAI,CAAC,YAAY,SAAS,MAAM,GAAG,GAAG;QACpC,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,MAAM,OAAO,MAAM,sJAAW,CAAC,UAAU;QACzC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,IAAI,MAAM;IAClB;AACF;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,IAAI;QACF,IAAI,CAAC,YAAY,CAAC,MAAM;YACtB,OAAO;QACT;QACA,MAAM,UAAU,MAAM,yJAAc,CAAC,UAAU;QAC/C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO;IACT;AACF;AAGO,eAAe,qBAAqB,QAAgB;IACzD,OAAO,MAAM,aAAa;AAC5B;AAEO,SAAS,mBAAmB,QAAgB;IACjD,oFAAoF;IACpF,kDAAkD;IAClD,MAAM;IACN,MAAM,OAAO,OAAO,WAAW,CAAC,IAAI,QAAQ,CAAC;IAC7C,MAAM,OAAO,OAAO,UAAU,CAAC,UAAU,MAAM,QAAQ,IAAI,UAAU,QAAQ,CAAC;IAC9E,OAAO;QAAE;QAAM;IAAK;AACtB"}},
    {"offset": {"line": 123, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/lib/security/login-attempts.ts"],"sourcesContent":["import NodeCache from 'node-cache';\r\n\r\nconst MAX_ATTEMPTS = 3;\r\nconst LOCKOUT_TIME = 15 * 60; // 15 minutes in seconds\r\nconst CACHE_CHECK_PERIOD = 60; // Clean up every 60 seconds\r\n\r\n// Using node-cache for in-memory storage (can be replaced with Redis)\r\nconst cache = new NodeCache({ stdTTL: LOCKOUT_TIME, checkperiod: CACHE_CHECK_PERIOD });\r\n\r\ninterface AttemptRecord {\r\n  count: number;\r\n  lastAttempt: number;\r\n  locked: boolean;\r\n}\r\n\r\nexport function checkLoginAttempts(email: string): {\r\n  allowed: boolean;\r\n  attemptsLeft: number;\r\n  message: string;\r\n  timeToUnlock?: number;\r\n} {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  const attempt = cache.get<AttemptRecord>(normalizedEmail);\r\n\r\n  if (!attempt) {\r\n    return {\r\n      allowed: true,\r\n      attemptsLeft: MAX_ATTEMPTS,\r\n      message: 'OK',\r\n    };\r\n  }\r\n\r\n  if (attempt.locked) {\r\n    const timeLeft = Math.max(0, LOCKOUT_TIME - Math.floor((Date.now() - attempt.lastAttempt) / 1000));\r\n    \r\n    if (timeLeft <= 0) {\r\n      cache.del(normalizedEmail);\r\n      return {\r\n        allowed: true,\r\n        attemptsLeft: MAX_ATTEMPTS,\r\n        message: 'OK',\r\n      };\r\n    }\r\n\r\n    return {\r\n      allowed: false,\r\n      attemptsLeft: 0,\r\n      message: `Account temporarily locked. Try again in ${timeLeft} seconds.`,\r\n      timeToUnlock: timeLeft,\r\n    };\r\n  }\r\n\r\n  return {\r\n    allowed: true,\r\n    attemptsLeft: Math.max(0, MAX_ATTEMPTS - attempt.count),\r\n    message: 'OK',\r\n  };\r\n}\r\n\r\nexport function recordFailedAttempt(email: string): void {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  const attempt = cache.get<AttemptRecord>(normalizedEmail) || { count: 0, lastAttempt: Date.now(), locked: false };\r\n\r\n  attempt.count += 1;\r\n  attempt.lastAttempt = Date.now();\r\n\r\n  if (attempt.count >= MAX_ATTEMPTS) {\r\n    attempt.locked = true;\r\n  }\r\n\r\n  cache.set(normalizedEmail, attempt, LOCKOUT_TIME);\r\n}\r\n\r\nexport function clearLoginAttempts(email: string): void {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  cache.del(normalizedEmail);\r\n}\r\n\r\nexport function isAccountLocked(email: string): boolean {\r\n  const normalizedEmail = email.toLowerCase().trim();\r\n  const attempt = cache.get<AttemptRecord>(normalizedEmail);\r\n  return attempt?.locked ?? false;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,eAAe;AACrB,MAAM,eAAe,KAAK,IAAI,wBAAwB;AACtD,MAAM,qBAAqB,IAAI,4BAA4B;AAE3D,sEAAsE;AACtE,MAAM,QAAQ,IAAI,8JAAS,CAAC;IAAE,QAAQ;IAAc,aAAa;AAAmB;AAQ7E,SAAS,mBAAmB,KAAa;IAM9C,MAAM,kBAAkB,MAAM,WAAW,GAAG,IAAI;IAChD,MAAM,UAAU,MAAM,GAAG,CAAgB;IAEzC,IAAI,CAAC,SAAS;QACZ,OAAO;YACL,SAAS;YACT,cAAc;YACd,SAAS;QACX;IACF;IAEA,IAAI,QAAQ,MAAM,EAAE;QAClB,MAAM,WAAW,KAAK,GAAG,CAAC,GAAG,eAAe,KAAK,KAAK,CAAC,CAAC,KAAK,GAAG,KAAK,QAAQ,WAAW,IAAI;QAE5F,IAAI,YAAY,GAAG;YACjB,MAAM,GAAG,CAAC;YACV,OAAO;gBACL,SAAS;gBACT,cAAc;gBACd,SAAS;YACX;QACF;QAEA,OAAO;YACL,SAAS;YACT,cAAc;YACd,SAAS,CAAC,yCAAyC,EAAE,SAAS,SAAS,CAAC;YACxE,cAAc;QAChB;IACF;IAEA,OAAO;QACL,SAAS;QACT,cAAc,KAAK,GAAG,CAAC,GAAG,eAAe,QAAQ,KAAK;QACtD,SAAS;IACX;AACF;AAEO,SAAS,oBAAoB,KAAa;IAC/C,MAAM,kBAAkB,MAAM,WAAW,GAAG,IAAI;IAChD,MAAM,UAAU,MAAM,GAAG,CAAgB,oBAAoB;QAAE,OAAO;QAAG,aAAa,KAAK,GAAG;QAAI,QAAQ;IAAM;IAEhH,QAAQ,KAAK,IAAI;IACjB,QAAQ,WAAW,GAAG,KAAK,GAAG;IAE9B,IAAI,QAAQ,KAAK,IAAI,cAAc;QACjC,QAAQ,MAAM,GAAG;IACnB;IAEA,MAAM,GAAG,CAAC,iBAAiB,SAAS;AACtC;AAEO,SAAS,mBAAmB,KAAa;IAC9C,MAAM,kBAAkB,MAAM,WAAW,GAAG,IAAI;IAChD,MAAM,GAAG,CAAC;AACZ;AAEO,SAAS,gBAAgB,KAAa;IAC3C,MAAM,kBAAkB,MAAM,WAAW,GAAG,IAAI;IAChD,MAAM,UAAU,MAAM,GAAG,CAAgB;IACzC,OAAO,SAAS,UAAU;AAC5B"}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/lib/security/input-validation.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\nexport const LoginSchema = z.object({\r\n  email: z.string().email('Invalid email format').toLowerCase().trim(),\r\n  password: z.string().min(8, 'Password must be at least 8 characters'),\r\n});\r\n\r\nexport const ProductSchema = z.object({\r\n  code: z.string().min(1).max(50).toUpperCase().trim(),\r\n  name: z.string().min(1).max(255).trim(),\r\n  description: z.string().max(1000).trim().optional(),\r\n  categoryId: z.number().positive(),\r\n  price: z.number().positive('Price must be positive'),\r\n  size: z.string().max(50).trim().optional(),\r\n  color: z.string().max(100).trim().optional(),\r\n  gender: z.string().max(50).trim().optional(),\r\n  stock: z.number().int().nonnegative('Stock cannot be negative').default(0),\r\n});\r\n\r\nexport type LoginInput = z.infer<typeof LoginSchema>;\r\nexport type ProductInput = z.infer<typeof ProductSchema>;\r\n\r\nexport function validateLogin(data: unknown) {\r\n  return LoginSchema.safeParse(data);\r\n}\r\n\r\nexport function validateProduct(data: unknown) {\r\n  return ProductSchema.safeParse(data);\r\n}\r\n\r\nexport function validateEmail(email: string): boolean {\r\n  const emailSchema = z.string().email();\r\n  const result = emailSchema.safeParse(email.toLowerCase().trim());\r\n  return result.success;\r\n}\r\n\r\nexport function sanitizeString(input: string): string {\r\n  return input.replace(/[<>\\\"'&]/g, (char) => {\r\n    const map: { [key: string]: string } = {\r\n      '<': '&lt;',\r\n      '>': '&gt;',\r\n      '\"': '&quot;',\r\n      \"'\": '&#x27;',\r\n      '&': '&amp;',\r\n    };\r\n    return map[char];\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEO,MAAM,cAAc,oLAAC,CAAC,MAAM,CAAC;IAClC,OAAO,oLAAC,CAAC,MAAM,GAAG,KAAK,CAAC,wBAAwB,WAAW,GAAG,IAAI;IAClE,UAAU,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;AAC9B;AAEO,MAAM,gBAAgB,oLAAC,CAAC,MAAM,CAAC;IACpC,MAAM,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,WAAW,GAAG,IAAI;IAClD,MAAM,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,IAAI;IACrC,aAAa,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,MAAM,IAAI,GAAG,QAAQ;IACjD,YAAY,oLAAC,CAAC,MAAM,GAAG,QAAQ;IAC/B,OAAO,oLAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,MAAM,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI,IAAI,GAAG,QAAQ;IACxC,OAAO,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,IAAI,GAAG,QAAQ;IAC1C,QAAQ,oLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI,IAAI,GAAG,QAAQ;IAC1C,OAAO,oLAAC,CAAC,MAAM,GAAG,GAAG,GAAG,WAAW,CAAC,4BAA4B,OAAO,CAAC;AAC1E;AAKO,SAAS,cAAc,IAAa;IACzC,OAAO,YAAY,SAAS,CAAC;AAC/B;AAEO,SAAS,gBAAgB,IAAa;IAC3C,OAAO,cAAc,SAAS,CAAC;AACjC;AAEO,SAAS,cAAc,KAAa;IACzC,MAAM,cAAc,oLAAC,CAAC,MAAM,GAAG,KAAK;IACpC,MAAM,SAAS,YAAY,SAAS,CAAC,MAAM,WAAW,GAAG,IAAI;IAC7D,OAAO,OAAO,OAAO;AACvB;AAEO,SAAS,eAAe,KAAa;IAC1C,OAAO,MAAM,OAAO,CAAC,aAAa,CAAC;QACjC,MAAM,MAAiC;YACrC,KAAK;YACL,KAAK;YACL,KAAK;YACL,KAAK;YACL,KAAK;QACP;QACA,OAAO,GAAG,CAAC,KAAK;IAClB;AACF"}},
    {"offset": {"line": 261, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/lib/security/rate-limit.ts"],"sourcesContent":["import NodeCache from 'node-cache';\r\n\r\ninterface RateLimitConfig {\r\n  windowMs: number; // Time window in milliseconds\r\n  maxRequests: number; // Max requests per window\r\n}\r\n\r\nconst DEFAULT_CONFIG: RateLimitConfig = {\r\n  windowMs: 60 * 1000, // 1 minute\r\n  maxRequests: 30,\r\n};\r\n\r\nclass RateLimiter {\r\n  private cache = new NodeCache({ stdTTL: 60, checkperiod: 30 });\r\n  private config: RateLimitConfig;\r\n\r\n  constructor(config: Partial<RateLimitConfig> = {}) {\r\n    this.config = { ...DEFAULT_CONFIG, ...config };\r\n  }\r\n\r\n  check(identifier: string): { allowed: boolean; remaining: number } {\r\n    const key = `ratelimit:${identifier}`;\r\n    let count = this.cache.get<number>(key) || 0;\r\n\r\n    if (count >= this.config.maxRequests) {\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n      };\r\n    }\r\n\r\n    count += 1;\r\n    this.cache.set(key, count, Math.ceil(this.config.windowMs / 1000));\r\n\r\n    return {\r\n      allowed: true,\r\n      remaining: this.config.maxRequests - count,\r\n    };\r\n  }\r\n\r\n  reset(identifier: string): void {\r\n    this.cache.del(`ratelimit:${identifier}`);\r\n  }\r\n}\r\n\r\nexport const apiLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 100,\r\n});\r\n\r\nexport const loginLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 10,\r\n});\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAOA,MAAM,iBAAkC;IACtC,UAAU,KAAK;IACf,aAAa;AACf;AAEA,MAAM;IACI,QAAQ,IAAI,8JAAS,CAAC;QAAE,QAAQ;QAAI,aAAa;IAAG,GAAG;IACvD,OAAwB;IAEhC,YAAY,SAAmC,CAAC,CAAC,CAAE;QACjD,IAAI,CAAC,MAAM,GAAG;YAAE,GAAG,cAAc;YAAE,GAAG,MAAM;QAAC;IAC/C;IAEA,MAAM,UAAkB,EAA2C;QACjE,MAAM,MAAM,CAAC,UAAU,EAAE,YAAY;QACrC,IAAI,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAS,QAAQ;QAE3C,IAAI,SAAS,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE;YACpC,OAAO;gBACL,SAAS;gBACT,WAAW;YACb;QACF;QAEA,SAAS;QACT,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,OAAO,KAAK,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,GAAG;QAE5D,OAAO;YACL,SAAS;YACT,WAAW,IAAI,CAAC,MAAM,CAAC,WAAW,GAAG;QACvC;IACF;IAEA,MAAM,UAAkB,EAAQ;QAC9B,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,YAAY;IAC1C;AACF;AAEO,MAAM,aAAa,IAAI,YAAY;IACxC,UAAU,KAAK,KAAK;IACpB,aAAa;AACf;AAEO,MAAM,eAAe,IAAI,YAAY;IAC1C,UAAU,KAAK,KAAK;IACpB,aAAa;AACf"}},
    {"offset": {"line": 323, "column": 0}, "map": {"version":3,"sources":["file:///C:/data/Sistema/app/api/auth/login/route.ts"],"sourcesContent":["import { sql } from '@/lib/database';\r\nimport { hashPassword, verifyPassword } from '@/lib/security/password-hash';\r\nimport { checkLoginAttempts, recordFailedAttempt, clearLoginAttempts } from '@/lib/security/login-attempts';\r\nimport { validateLogin, sanitizeString } from '@/lib/security/input-validation';\r\nimport { apiLimiter } from '@/lib/security/rate-limit';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport * as crypto from 'crypto';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n    const rateLimitCheck = apiLimiter.check(`login:${ip}`);\r\n    \r\n    if (!rateLimitCheck.allowed) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: 'Demasiados intentos de inicio de sesión. Por favor, intenta nuevamente en 15 minutos.',\r\n          error_code: 'RATE_LIMIT_EXCEEDED',\r\n        },\r\n        { status: 429, headers: { 'Retry-After': '900' } }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n\r\n    const validation = validateLogin(body);\r\n    if (!validation.success) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: 'Por favor, verifica que el correo electrónico y la contraseña sean válidos.',\r\n          errors: validation.error.flatten(),\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const { email, password } = validation.data;\r\n\r\n    // Verificar intentos de login antes de consultar la base de datos\r\n    const attemptCheck = checkLoginAttempts(email);\r\n    if (!attemptCheck.allowed) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: 'Cuenta bloqueada temporalmente. Has excedido el número máximo de intentos (3). Intenta nuevamente en 15 minutos.',\r\n          attemptsLeft: 0,\r\n          locked: true,\r\n          error_code: 'ACCOUNT_LOCKED',\r\n        },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    // Buscar usuario en la base de datos\r\n    const users = await sql`\r\n      SELECT u.id, u.password_hash, u.email, u.role_id, u.first_name, u.last_name, u.active, r.name as role_name\r\n      FROM users u\r\n      LEFT JOIN roles r ON u.role_id = r.id\r\n      WHERE LOWER(u.email) = LOWER(${email}) AND (u.active = true OR u.active IS NULL)\r\n    `;\r\n\r\n    // Usuario no existe\r\n    if (users.length === 0) {\r\n      recordFailedAttempt(email);\r\n      const remainingAttempts = Math.max(0, attemptCheck.attemptsLeft - 1);\r\n\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: remainingAttempts > 0 \r\n            ? `Credenciales inválidas. Te quedan ${remainingAttempts} ${remainingAttempts === 1 ? 'intento' : 'intentos'}.`\r\n            : 'Cuenta bloqueada. Has excedido el número máximo de intentos.',\r\n          attemptsLeft: remainingAttempts,\r\n          locked: remainingAttempts === 0,\r\n          error_code: 'INVALID_CREDENTIALS',\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const user = users[0];\r\n\r\n    // Verificar contraseña\r\n    const passwordMatch = await verifyPassword(password, user.password_hash);\r\n\r\n    if (!passwordMatch) {\r\n      recordFailedAttempt(email);\r\n      const remainingAttempts = Math.max(0, attemptCheck.attemptsLeft - 1);\r\n      \r\n      // Registrar intento fallido en audit log (usuario existe pero contraseña incorrecta)\r\n      try {\r\n        await sql`\r\n          INSERT INTO login_audit_log (user_id, email, ip_address, success, timestamp)\r\n          VALUES (${user.id}, ${email}, ${ip}, false, NOW())\r\n        `;\r\n      } catch (auditError) {\r\n        console.error('[Audit Log Error]', auditError);\r\n      }\r\n\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          message: remainingAttempts > 0 \r\n            ? `Credenciales inválidas. Te quedan ${remainingAttempts} ${remainingAttempts === 1 ? 'intento' : 'intentos'}.`\r\n            : 'Cuenta bloqueada. Has excedido el número máximo de intentos.',\r\n          attemptsLeft: remainingAttempts,\r\n          locked: remainingAttempts === 0,\r\n          error_code: 'INVALID_CREDENTIALS',\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Login exitoso\r\n    clearLoginAttempts(email);\r\n\r\n    const sessionToken = crypto.randomBytes(32).toString('hex');\r\n    const sessionExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000);\r\n\r\n    // Registrar login exitoso en audit log\r\n    try {\r\n      await sql`\r\n        INSERT INTO login_audit_log (user_id, email, ip_address, success, timestamp)\r\n        VALUES (${user.id}, ${email}, ${ip}, true, NOW())\r\n      `;\r\n    } catch (auditError) {\r\n      console.error('[Audit Log Error]', auditError);\r\n    }\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: '¡Bienvenido de nuevo!',\r\n        user: {\r\n          id: user.id,\r\n          email: sanitizeString(user.email),\r\n          firstName: sanitizeString(user.first_name || ''),\r\n          lastName: sanitizeString(user.last_name || ''),\r\n          role: user.role_name || 'USER',\r\n          roleId: user.role_id,\r\n        },\r\n        sessionToken,\r\n        expiresAt: sessionExpiry.toISOString(),\r\n      },\r\n      {\r\n        status: 200,\r\n        headers: {\r\n          'Set-Cookie': `sessionToken=${sessionToken}; HttpOnly; Secure; SameSite=Strict; Max-Age=${24 * 60 * 60}; Path=/`,\r\n        },\r\n      }\r\n    );\r\n  } catch (error) {\r\n    console.error('[Login Error]', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        message: 'Ha ocurrido un error en el servidor. Por favor, intenta nuevamente más tarde.',\r\n        error_code: 'INTERNAL_SERVER_ERROR',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}