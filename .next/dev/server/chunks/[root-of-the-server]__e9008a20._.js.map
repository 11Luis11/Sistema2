{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/lib/database.ts"],"sourcesContent":["// Neon database connection\r\nimport { neon } from '@neondatabase/serverless';\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  throw new Error('DATABASE_URL environment variable is not set');\r\n}\r\n\r\nconst sql = neon(process.env.DATABASE_URL!);\r\n\r\nexport { sql };\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;AAC3B;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY"}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/lib/security/rate-limit.ts"],"sourcesContent":["import NodeCache from 'node-cache';\r\n\r\ninterface RateLimitConfig {\r\n  windowMs: number; // Time window in milliseconds\r\n  maxRequests: number; // Max requests per window\r\n}\r\n\r\nconst DEFAULT_CONFIG: RateLimitConfig = {\r\n  windowMs: 60 * 1000, // 1 minute\r\n  maxRequests: 30,\r\n};\r\n\r\nclass RateLimiter {\r\n  private cache = new NodeCache({ stdTTL: 60, checkperiod: 30 });\r\n  private config: RateLimitConfig;\r\n\r\n  constructor(config: Partial<RateLimitConfig> = {}) {\r\n    this.config = { ...DEFAULT_CONFIG, ...config };\r\n  }\r\n\r\n  check(identifier: string): { allowed: boolean; remaining: number } {\r\n    const key = `ratelimit:${identifier}`;\r\n    let count = this.cache.get<number>(key) || 0;\r\n\r\n    if (count >= this.config.maxRequests) {\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n      };\r\n    }\r\n\r\n    count += 1;\r\n    this.cache.set(key, count, Math.ceil(this.config.windowMs / 1000));\r\n\r\n    return {\r\n      allowed: true,\r\n      remaining: this.config.maxRequests - count,\r\n    };\r\n  }\r\n\r\n  reset(identifier: string): void {\r\n    this.cache.del(`ratelimit:${identifier}`);\r\n  }\r\n}\r\n\r\nexport const apiLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 100,\r\n});\r\n\r\nexport const loginLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 10,\r\n});\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAOA,MAAM,iBAAkC;IACtC,UAAU,KAAK;IACf,aAAa;AACf;AAEA,MAAM;IACI,QAAQ,IAAI,mJAAS,CAAC;QAAE,QAAQ;QAAI,aAAa;IAAG,GAAG;IACvD,OAAwB;IAEhC,YAAY,SAAmC,CAAC,CAAC,CAAE;QACjD,IAAI,CAAC,MAAM,GAAG;YAAE,GAAG,cAAc;YAAE,GAAG,MAAM;QAAC;IAC/C;IAEA,MAAM,UAAkB,EAA2C;QACjE,MAAM,MAAM,CAAC,UAAU,EAAE,YAAY;QACrC,IAAI,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAS,QAAQ;QAE3C,IAAI,SAAS,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE;YACpC,OAAO;gBACL,SAAS;gBACT,WAAW;YACb;QACF;QAEA,SAAS;QACT,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,OAAO,KAAK,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,GAAG;QAE5D,OAAO;YACL,SAAS;YACT,WAAW,IAAI,CAAC,MAAM,CAAC,WAAW,GAAG;QACvC;IACF;IAEA,MAAM,UAAkB,EAAQ;QAC9B,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,YAAY;IAC1C;AACF;AAEO,MAAM,aAAa,IAAI,YAAY;IACxC,UAAU,KAAK,KAAK;IACpB,aAAa;AACf;AAEO,MAAM,eAAe,IAAI,YAAY;IAC1C,UAAU,KAAK,KAAK;IACpB,aAAa;AACf"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/app/api/suppliers/route.ts"],"sourcesContent":["import { sql } from '@/lib/database';\r\nimport { apiLimiter } from '@/lib/security/rate-limit';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\nfunction getRoleFromRequest(request: NextRequest): string | null {\r\n  return request.headers.get('X-User-Role') || null;\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n    const rateLimitCheck = apiLimiter.check(`suppliers:get:${ip}`);\r\n\r\n    if (!rateLimitCheck.allowed) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Rate limit exceeded' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const search = searchParams.get('search') || '';\r\n    const limit = parseInt(searchParams.get('limit') || '100');\r\n\r\n    const searchPattern = `%${search}%`;\r\n\r\n    const suppliers = await sql`\r\n      SELECT \r\n        s.*,\r\n        COUNT(ps.product_id) as products_count\r\n      FROM suppliers s\r\n      LEFT JOIN product_suppliers ps ON s.id = ps.supplier_id\r\n      WHERE s.active = true \r\n        AND (s.name ILIKE ${searchPattern} OR s.code ILIKE ${searchPattern})\r\n      GROUP BY s.id\r\n      ORDER BY s.created_at DESC\r\n      LIMIT ${limit}\r\n    `;\r\n\r\n    return NextResponse.json({ success: true, suppliers });\r\n  } catch (error) {\r\n    console.error('[Suppliers GET Error]', error);\r\n    return NextResponse.json(\r\n      { success: false, message: 'Error fetching suppliers' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n    const rateLimitCheck = apiLimiter.check(`suppliers:post:${ip}`);\r\n\r\n    if (!rateLimitCheck.allowed) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Rate limit exceeded' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const role = getRoleFromRequest(request);\r\n\r\n    if (!['Administrator', 'Manager'].includes(role || '')) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Unauthorized' },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { code, name, contactName, email, phone, address, city, country, taxId, notes } = body;\r\n\r\n    if (!code || !name) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Code and name are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const existing = await sql`\r\n      SELECT id FROM suppliers WHERE UPPER(code) = UPPER(${code})\r\n    `;\r\n\r\n    if (existing.length > 0) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Supplier code already exists' },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    const result = await sql`\r\n      INSERT INTO suppliers (code, name, contact_name, email, phone, address, city, country, tax_id, notes, active)\r\n      VALUES (${code}, ${name}, ${contactName || null}, ${email || null}, ${phone || null}, \r\n              ${address || null}, ${city || null}, ${country || 'Per√∫'}, ${taxId || null}, ${notes || null}, true)\r\n      RETURNING *\r\n    `;\r\n\r\n    return NextResponse.json(\r\n      { success: true, message: 'Supplier created successfully', supplier: result[0] },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    console.error('[Suppliers POST Error]', error);\r\n    return NextResponse.json(\r\n      { success: false, message: 'Error creating supplier' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n    const rateLimitCheck = apiLimiter.check(`suppliers:delete:${ip}`);\r\n\r\n    if (!rateLimitCheck.allowed) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Rate limit exceeded' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const role = getRoleFromRequest(request);\r\n\r\n    if (!['Administrator', 'Manager'].includes(role || '')) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Unauthorized' },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const id = searchParams.get('id');\r\n\r\n    if (!id) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Supplier ID required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Soft delete\r\n    const result = await sql`\r\n      UPDATE suppliers\r\n      SET active = false, updated_at = NOW()\r\n      WHERE id = ${parseInt(id)} AND active = true\r\n      RETURNING id, name\r\n    `;\r\n\r\n    if (result.length === 0) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Supplier not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Supplier deleted successfully'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Suppliers DELETE Error]', error);\r\n    return NextResponse.json(\r\n      { success: false, message: 'Error deleting supplier' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}