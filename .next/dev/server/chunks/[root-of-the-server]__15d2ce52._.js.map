{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/lib/database.ts"],"sourcesContent":["// Neon database connection\r\nimport { neon } from '@neondatabase/serverless';\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  throw new Error('DATABASE_URL environment variable is not set');\r\n}\r\n\r\nconst sql = neon(process.env.DATABASE_URL!);\r\n\r\nexport { sql };\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;AAC3B;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY"}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/lib/security/rate-limit.ts"],"sourcesContent":["import NodeCache from 'node-cache';\r\n\r\ninterface RateLimitConfig {\r\n  windowMs: number; // Time window in milliseconds\r\n  maxRequests: number; // Max requests per window\r\n}\r\n\r\nconst DEFAULT_CONFIG: RateLimitConfig = {\r\n  windowMs: 60 * 1000, // 1 minute\r\n  maxRequests: 30,\r\n};\r\n\r\nclass RateLimiter {\r\n  private cache = new NodeCache({ stdTTL: 60, checkperiod: 30 });\r\n  private config: RateLimitConfig;\r\n\r\n  constructor(config: Partial<RateLimitConfig> = {}) {\r\n    this.config = { ...DEFAULT_CONFIG, ...config };\r\n  }\r\n\r\n  check(identifier: string): { allowed: boolean; remaining: number } {\r\n    const key = `ratelimit:${identifier}`;\r\n    let count = this.cache.get<number>(key) || 0;\r\n\r\n    if (count >= this.config.maxRequests) {\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n      };\r\n    }\r\n\r\n    count += 1;\r\n    this.cache.set(key, count, Math.ceil(this.config.windowMs / 1000));\r\n\r\n    return {\r\n      allowed: true,\r\n      remaining: this.config.maxRequests - count,\r\n    };\r\n  }\r\n\r\n  reset(identifier: string): void {\r\n    this.cache.del(`ratelimit:${identifier}`);\r\n  }\r\n}\r\n\r\nexport const apiLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 100,\r\n});\r\n\r\nexport const loginLimiter = new RateLimiter({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  maxRequests: 10,\r\n});\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAOA,MAAM,iBAAkC;IACtC,UAAU,KAAK;IACf,aAAa;AACf;AAEA,MAAM;IACI,QAAQ,IAAI,mJAAS,CAAC;QAAE,QAAQ;QAAI,aAAa;IAAG,GAAG;IACvD,OAAwB;IAEhC,YAAY,SAAmC,CAAC,CAAC,CAAE;QACjD,IAAI,CAAC,MAAM,GAAG;YAAE,GAAG,cAAc;YAAE,GAAG,MAAM;QAAC;IAC/C;IAEA,MAAM,UAAkB,EAA2C;QACjE,MAAM,MAAM,CAAC,UAAU,EAAE,YAAY;QACrC,IAAI,QAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAS,QAAQ;QAE3C,IAAI,SAAS,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE;YACpC,OAAO;gBACL,SAAS;gBACT,WAAW;YACb;QACF;QAEA,SAAS;QACT,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,OAAO,KAAK,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,GAAG;QAE5D,OAAO;YACL,SAAS;YACT,WAAW,IAAI,CAAC,MAAM,CAAC,WAAW,GAAG;QACvC;IACF;IAEA,MAAM,UAAkB,EAAQ;QAC9B,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,YAAY;IAC1C;AACF;AAEO,MAAM,aAAa,IAAI,YAAY;IACxC,UAAU,KAAK,KAAK;IACpB,aAAa;AACf;AAEO,MAAM,eAAe,IAAI,YAAY;IAC1C,UAAU,KAAK,KAAK;IACpB,aAAa;AACf"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luist/Sistema/app/api/analytics/route.ts"],"sourcesContent":["import { sql } from '@/lib/database';\r\nimport { apiLimiter } from '@/lib/security/rate-limit';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n    const rateLimitCheck = apiLimiter.check(`analytics:get:${ip}`);\r\n\r\n    if (!rateLimitCheck.allowed) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Rate limit exceeded' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n\r\n    const authHeader = request.headers.get('authorization');\r\n    \r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'No autorizado' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const period = parseInt(searchParams.get('period') || '30');\r\n\r\n    const startDate = new Date();\r\n    startDate.setDate(startDate.getDate() - period);\r\n    const startDateString = startDate.toISOString();\r\n\r\n    console.log('[Analytics] Period:', period, 'Start Date:', startDateString);\r\n\r\n    // 1. Estadísticas de productos\r\n    const totalProducts = await sql`\r\n      SELECT COUNT(*) as count FROM products WHERE active = true\r\n    `;\r\n\r\n    const lowStock = await sql`\r\n      SELECT COUNT(*) as count FROM products WHERE active = true AND current_stock < 10\r\n    `;\r\n\r\n    const totalValue = await sql`\r\n      SELECT COALESCE(SUM(price * current_stock), 0) as total\r\n      FROM products WHERE active = true\r\n    `;\r\n\r\n    // 2. Estadísticas de ventas\r\n    const salesStats = await sql`\r\n      SELECT \r\n        COUNT(*) as total_sales,\r\n        COALESCE(SUM(total_amount), 0) as total_revenue,\r\n        COALESCE(AVG(total_amount), 0) as average_sale\r\n      FROM sales\r\n      WHERE created_at >= ${startDateString}\r\n    `;\r\n\r\n    console.log('[Analytics] Sales Stats:', salesStats[0]);\r\n\r\n    // 3. Ventas por día (últimos 7 días)\r\n    const salesByDay = await sql`\r\n      SELECT \r\n        DATE(created_at) as date,\r\n        COUNT(*) as sales_count,\r\n        COALESCE(SUM(total_amount), 0) as revenue\r\n      FROM sales\r\n      WHERE created_at >= NOW() - INTERVAL '7 days'\r\n      GROUP BY DATE(created_at)\r\n      ORDER BY date DESC\r\n    `;\r\n\r\n    console.log('[Analytics] Sales by Day:', salesByDay);\r\n\r\n    // 4. Top 5 productos más vendidos\r\n    const topSellingProducts = await sql`\r\n      SELECT \r\n        si.product_name,\r\n        si.product_code,\r\n        SUM(si.quantity) as total_sold,\r\n        COALESCE(SUM(si.subtotal), 0) as total_revenue,\r\n        COUNT(DISTINCT si.sale_id) as sales_count\r\n      FROM sale_items si\r\n      JOIN sales s ON si.sale_id = s.id\r\n      WHERE s.created_at >= ${startDateString}\r\n      GROUP BY si.product_id, si.product_name, si.product_code\r\n      ORDER BY total_sold DESC\r\n      LIMIT 5\r\n    `;\r\n\r\n    console.log('[Analytics] Top Products:', topSellingProducts);\r\n\r\n    // 5. Ventas por método de pago\r\n    const salesByPaymentMethod = await sql`\r\n      SELECT \r\n        COALESCE(payment_method, 'No especificado') as payment_method,\r\n        COUNT(*) as count,\r\n        COALESCE(SUM(total_amount), 0) as total\r\n      FROM sales\r\n      WHERE created_at >= ${startDateString}\r\n      GROUP BY payment_method\r\n      ORDER BY total DESC\r\n    `;\r\n\r\n    console.log('[Analytics] Payment Methods:', salesByPaymentMethod);\r\n\r\n    // 6. Productos por categoría\r\n    const productsByCategory = await sql`\r\n      SELECT \r\n        c.name as category,\r\n        COUNT(p.id) as count,\r\n        COALESCE(SUM(p.current_stock), 0) as total_stock\r\n      FROM categories c\r\n      LEFT JOIN products p ON c.id = p.category_id AND p.active = true\r\n      GROUP BY c.id, c.name\r\n      ORDER BY count DESC\r\n    `;\r\n\r\n    // 7. Proveedores activos\r\n    const suppliersStats = await sql`\r\n      SELECT \r\n        COUNT(*) as total_suppliers,\r\n        COUNT(DISTINCT ps.supplier_id) as active_suppliers\r\n      FROM suppliers s\r\n      LEFT JOIN product_suppliers ps ON s.id = ps.supplier_id\r\n      WHERE s.active = true\r\n    `;\r\n\r\n    const response = {\r\n      success: true,\r\n      analytics: {\r\n        summary: {\r\n          totalProducts: parseInt(totalProducts[0]?.count || '0'),\r\n          lowStockProducts: parseInt(lowStock[0]?.count || '0'),\r\n          totalInventoryValue: parseFloat(totalValue[0]?.total || '0'),\r\n          totalSales: parseInt(salesStats[0]?.total_sales || '0'),\r\n          totalRevenue: parseFloat(salesStats[0]?.total_revenue || '0'),\r\n          averageSale: parseFloat(salesStats[0]?.average_sale || '0'),\r\n          totalSuppliers: parseInt(suppliersStats[0]?.total_suppliers || '0'),\r\n          activeSuppliers: parseInt(suppliersStats[0]?.active_suppliers || '0'),\r\n        },\r\n        sales: {\r\n          byDay: salesByDay.map(row => ({\r\n            date: row.date,\r\n            sales_count: parseInt(row.sales_count || '0'),\r\n            revenue: parseFloat(row.revenue || '0')\r\n          })),\r\n          byPaymentMethod: salesByPaymentMethod.map(row => ({\r\n            payment_method: row.payment_method,\r\n            count: parseInt(row.count || '0'),\r\n            total: parseFloat(row.total || '0')\r\n          })),\r\n          topProducts: topSellingProducts.map(row => ({\r\n            product_name: row.product_name,\r\n            product_code: row.product_code,\r\n            total_sold: parseInt(row.total_sold || '0'),\r\n            total_revenue: parseFloat(row.total_revenue || '0'),\r\n            sales_count: parseInt(row.sales_count || '0')\r\n          }))\r\n        },\r\n        products: {\r\n          byCategory: productsByCategory.map(row => ({\r\n            category: row.category,\r\n            count: parseInt(row.count || '0'),\r\n            total_stock: parseInt(row.total_stock || '0')\r\n          }))\r\n        },\r\n        period: period,\r\n      }\r\n    };\r\n\r\n    console.log('[Analytics] Final Response Summary:', {\r\n      totalSales: response.analytics.summary.totalSales,\r\n      totalRevenue: response.analytics.summary.totalRevenue,\r\n      topProductsCount: response.analytics.sales.topProducts.length,\r\n      paymentMethodsCount: response.analytics.sales.byPaymentMethod.length\r\n    });\r\n\r\n    return NextResponse.json(response);\r\n\r\n  } catch (error) {\r\n    console.error('[Analytics GET Error]', error);\r\n    return NextResponse.json(\r\n      { \r\n        success: false, \r\n        message: 'Error al obtener analytics',\r\n        error: error instanceof Error ? error.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}